<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oficina AutoGyn</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">
</head>

<body>
    <main>
        <aside>
            <div>
                <img src="/img/logo.png" alt="" width="80%">
                <span class="linha"></span>
            </div>
            <nav>
                <a class="menu abrirVeiculo" id="veiculos"><img src="/img/veiculo.svg" alt="" width="20"> Veiculos</a>
                <ul class="abrirVeiculo" hidden>
                    <li><a href="veiculoCadAt">Cadastrar | Atualizar</a></li>
                    <li><a href="veiculoMarMo">Marca | Modelo</a></li>
                    <li><a href="acessorios">Acessórios</a></li>
                    <li><a href="veiculoLista">Listar Veiculos</a></li>
                </ul>
                <a href="clientes"><img src="/img/cliente.svg" alt="" width="20"> Clientes</a>
                <a class="menu abrirOs" id="os"><img src="/img/ordem.svg" alt="" width="20"> Ordem de Serviço</a>
                <ul class="abrirOs">
                    <li><a href="cadastroSerPe">Serviços | Peças</a></li>
                    <li><a href="cadastroColab">Colaborador</a></li>
                    <li><a href="gerencOs" class="selecionado">Gerenciamento de OS</a></li>
                </ul>
                <a href="estoque"><img src="/img/estoque.svg" alt="" width="20">Estoque</a>
            </nav>
        </aside>

        <section class="osLista">
            <form id="os-form" class="">
                <div class="conteudoOS">
                    <div>
                        <div>
                            <div>
                                <h1>Cadastrar ordem de serviço</h1>
                                <p>Preencha os dados da OS para cadastro</p>
                            </div>
                            <div class="veiculoSelect">
                                <select name="veiculo" id="veiculo" required>
                                    <!-- populado pelo back -->
                                </select>
                            </div>
                            <div>
                                <label for="orcamento">Valor do Orçamento</label>
                                <input type="number" id="orcamento" placeholder="1200" required>
                            </div>
                        </div>
                        <span class="linha"></span>
                        <div>
                            <div class="selecaoServicos">
                                <div class="select-box">
                                    <label for="servicos" class="abrirMultiSelect">Selecione os serviços</label>
                                    <ul id="servicos">
                                        <!-- populado pelo back -->
                                    </ul>
                                </div>
                                <div class="selected-options service">
                                    <!-- populado pelo back -->
                                </div>
                            </div>

                            <div class="selecaoPecas">
                                <div class="select-box">
                                    <label for="pecas" class="abrirMultiSelect">Selecione as peças</label>
                                    <ul id="pecas">
                                        <!-- populado pelo back -->
                                    </ul>
                                </div>
                                <div class="selected-options pecas">
                                    <!-- populado pelo back -->
                                </div>
                            </div>

                            <button type="submit">Cadastrar</button>
                        </div>
                    </div>
                </div>
            </form>
            
            <span class="linhaDois"></span>

            <div>
                <h1>Ordem de Serviço no sistema</h1>
                
                <div class="listaOs">
                    <div class="osIndex" id="0">
                        <div>
                            <h2>Nome Cliente</h2>
                            <span class="linhaDois"></span>
                        </div>
                        <div class="ordemServico">
                            <div>
                                <p>Veiculo</p>
                                <h3>Modelo (Marca) YYYY</h3>
                            </div>
                            <div>
                                <p>Data</p>
                                <h3>24/11/2024</h3>
                            </div>
                            <div>
                                <p>Valor Total</p>
                                <h3>R$100,00</h3>
                            </div>
                            <div>
                                <p>Status</p>
                                <h3>Aprovação</h3>
                            </div>
                        </div>
                    </div>
                </div>
                
                <script>
                function getOSs() {
                    const listaOs = document.querySelector('.listaOs');
                    if (!listaOs) {
                        console.error('Element with class "listaOs" not found');
                        return;
                    }

                    listaOs.innerHTML = '<div class="loading">Carregando...</div>';

                    fetch('/os/lista-cadastrados')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (!Array.isArray(data)) {
                                throw new Error('Data received is not an array');
                            }

                            listaOs.innerHTML = ''; // Clear loading message

                            if (data.length === 0) {
                                listaOs.innerHTML = '<div class="no-data">Nenhuma ordem de serviço encontrada</div>';
                                return;
                            }

                            data.forEach((os, index) => {
                                if (!os) return; // Skip if os is undefined

                                const osDiv = `
                                    <div class="osIndex" id="${index}">
                                        <div>
                                            <h2>${os.cliente || 'Cliente não informado'}</h2>
                                            <span class="linhaDois"></span>
                                        </div>
                                        <div class="ordemServico">
                                            <div>
                                                <p>Veiculo</p>
                                                <h3>${os.veiculo || 'Não informado'}</h3>
                                            </div>
                                            <div>
                                                <p>Data</p>
                                                <h3>${os.data || 'Não informada'}</h3>
                                            </div>
                                            <div>
                                                <p>Valor Total</p>
                                                <h3>${os.valor || 'R$ 0,00'}</h3>
                                            </div>
                                            <div>
                                                <p>Status</p>
                                                <h3>${os.status || 'Não informado'}</h3>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                listaOs.innerHTML += osDiv;
                            });
                        })
                        .catch(error => {
                            console.error('Error fetching OS data:', error);
                            listaOs.innerHTML = `
                                <div class="error">
                                    Erro ao carregar ordens de serviço<br>
                                    <small>${error.message}</small>
                                </div>
                            `;
                        });
                }

                document.addEventListener('DOMContentLoaded', getOSs);
                </script>
                
            </div>

            <!-- em orçamento add peças e serviço -->
            <!-- o resto apenas o estado -->
            <!-- estado finalização -> paga | pago nao mexe em nd -->
            <!-- fzr o fetch do form -->
            <form class="edicaoOs" style="display: none;" id="edicaoOs-form">
                <h1>Ordem de Serviço: Cliente tal</h1>

                <div>
                    <label for="pagamento">Valor pago</label>
                    <input type="number" id="pagamento" placeholder="5000" required>
                </div>

                <div>
                    <button type="button">Cancelar</button>
                    <button>Atualizar</button>
                </div>
            </form>
        </section>
    </main>

    <script src="script.js"></script>
    <script>
    
        document.addEventListener('DOMContentLoaded',() => {
            getVeiculos()
            getServicos()
            getPecas()
            getOSs()
        });

        // ARRUMAR O DE PATCH
        const selectBoxes = document.querySelectorAll('.abrirMultiSelect');
        const selectedOptionsDivs = document.querySelectorAll('.selected-options');

        selectBoxes.forEach((selecionado, index) => {
            selecionado.addEventListener('click', function () {
                selecionado.parentNode.classList.toggle('open');
            });
        });

        const checkboxGroups = document.querySelectorAll('.select-box');

        checkboxGroups.forEach((checkboxGroup, index) => {
            const checkboxes = checkboxGroup.querySelectorAll('input[type="checkbox"]');
            const selectedOptionsDiv = selectedOptionsDivs[index];

            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    const selected = [];
                    checkboxes.forEach(cb => {
                        if (cb.checked) {
                            selected.push(cb.parentElement.textContent.trim());
                        }
                    });
                });
            });
        });

        function updateSelectedServicos() {
            const selectedServicesDiv = document.querySelector('.selected-options.service');
            const selectedCheckboxes = document.querySelectorAll('.servico-checkbox:checked');
            const selectedServicos = [];

            selectedServicesDiv.innerHTML = ''; 

            selectedCheckboxes.forEach(checkbox => {
                const serviceName = checkbox.parentElement.textContent.trim();

                if (!selectedServicos.includes(serviceName)) {
                    selectedServicos.push(serviceName);

                    const serviceDiv = document.createElement('div');
                    serviceDiv.classList.add('service-item');

                    const serviceText = document.createElement('p');
                    serviceText.textContent = serviceName;

                    const collaboratorSelect = document.createElement('select');
                    collaboratorSelect.classList.add('colaborator-select');
                    collaboratorSelect.setAttribute('required', 'true');
                    getColaboradores(collaboratorSelect);

                    const quantityInput = document.createElement('input');
                    quantityInput.type = 'number';
                    quantityInput.classList.add('service-quantity');
                    quantityInput.min = 1;
                    quantityInput.value = 1;
                    quantityInput.setAttribute('required', 'true');

                    const quantityWrapper = document.createElement('div');
                    quantityWrapper.classList.add('infosServico');
                    quantityWrapper.appendChild(collaboratorSelect);
                    quantityWrapper.appendChild(quantityInput);

                    serviceDiv.appendChild(serviceText);
                    serviceDiv.appendChild(quantityWrapper);
                    selectedServicesDiv.appendChild(serviceDiv);
                }
            });
        }

        function updateSelectedPecas() {
            const selectedPecasDiv = document.querySelector('.selected-options.pecas');
            const selectedCheckboxes = document.querySelectorAll('.peca-checkbox:checked');
            const selectedPecas = [];

            selectedPecasDiv.innerHTML = '';

            selectedCheckboxes.forEach(checkbox => {
                const pecaName = checkbox.parentElement.textContent.trim();

                if (!selectedPecas.includes(pecaName)) {
                    selectedPecas.push(pecaName);

                    const pecaDiv = document.createElement('div');
                    pecaDiv.classList.add('peca-item');

                    const pecaText = document.createElement('p');
                    pecaText.textContent = pecaName;

                    const quantidadeInput = document.createElement('input');
                    quantidadeInput.type = 'number';
                    quantidadeInput.classList.add('peca-quantidade');
                    quantidadeInput.min = 1;
                    quantidadeInput.value = 1;
                    quantidadeInput.setAttribute('required', 'true');

                    pecaDiv.appendChild(pecaText);
                    pecaDiv.appendChild(quantidadeInput);
                    selectedPecasDiv.appendChild(pecaDiv);
                }
            });
        }

        const os = document.querySelectorAll('.osIndex')
        const editorOs = document.querySelector('.edicaoOs')
        os.forEach(aberta => {
            aberta.addEventListener('click', () => {
                editorOs.removeAttribute("style")
                aberta.parentNode.parentNode.setAttribute('style', 'display: none')
                getOsAlter(aberta.id)
            })
        })

        editorOs.parentNode.children[3].children[5].children[0].addEventListener('click', () => {
            os.forEach(aberta => {
                aberta.parentNode.parentNode.removeAttribute('style')
            })
            editorOs.setAttribute('style', 'display: none')
        })

        // NEM VAI EXISTIR
        function getOsAlter(idOs) {
            const edicaoOs = document.querySelector('.edicaoOs');
            edicaoOs.children[0].classList.remove(...edicaoOs.children[0].classList);
            edicaoOs.children[0].classList.add(idOs);
        }

        document.getElementById('edicaoOs-form').addEventListener('submit', function (event) {
            event.preventDefault();
            const edicaoOs = document.querySelector('.edicaoOs');

            const formData = new FormData(this);

            const formDataObj = {};
            formData.forEach((value, key) => {
                formDataObj[key] = value;
            });

            const jsonData = JSON.stringify(formDataObj);

            // Mudar endpoint
            fetch(`/ordem-servico/${edicaoOs.children[0].classList[0]}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: jsonData
            })
                .then(response => {
                    if (response.ok) {
                        alert('Ordem de serviço editada com sucesso!');
                    } else {
                        alert('Houve um erro ao enviar o formulário.');
                    }
                })
                .catch(error => {
                    console.error('Erro ao enviar o formulário:', error);
                    alert('Erro de rede. Tente novamente mais tarde.');
                });
        });

        function getVeiculos() {
            const container = document.getElementById('veiculo');
            container.innerHTML = '';

            fetch('/veiculo/lista-cadastro')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro na resposta da rede');
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.length) {
                        container.innerHTML = '<p>Nenhum veículo cadastrado ainda.</p>';
                        return
                    }

                    const defaultOption = document.createElement('option');
                    defaultOption.value = "";
                    defaultOption.textContent = "Selecione o Veículo";
                    defaultOption.disabled = true;
                    defaultOption.selected = true;
                    defaultOption.hidden = true;
                    container.appendChild(defaultOption);

                    data.forEach(veiculo => {
                        const option = document.createElement('option');
                        option.value = veiculo.id;
                        option.textContent = `${veiculo.modelo} (${veiculo.marca}) ${veiculo.anoFabricacao}`;
                        container.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Erro ao buscar a lista de veículos:', error);
                    document.querySelector('.veiculoSelect').innerHTML = '<p>Erro ao carregar a lista de veículos.</p>';
                });
        }

        function getServicos() {
            const container = document.querySelector('#servicos');
            container.innerHTML = ''; 

            fetch('/servico/formatado')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro na resposta da rede');
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.length) {
                        container.innerHTML = '<p>Nenhum serviço cadastrado ainda.</p>';
                        return;
                    }

                    data.forEach(servico => {
                        const servicoHtml = `
                            <li>
                                <label>
                                    <input type="checkbox" value="${servico.id}" class="servico-checkbox"> ${servico.formatado}
                                </label>
                            </li>
                        `;
                        container.innerHTML += servicoHtml;
                    });

                    const checkboxes = document.querySelectorAll('.servico-checkbox');
                    checkboxes.forEach(checkbox => {
                        checkbox.addEventListener('change', updateSelectedServicos);
                    });
                })
                .catch(error => {
                    console.error('Erro ao buscar a lista de serviços:', error);
                    container.innerHTML = '<p>Erro ao carregar a lista de serviços.</p>';
                });
        }

        function getPecas() {
            const container = document.querySelector('#pecas');
            container.innerHTML = '';

            fetch('/peca')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro na resposta da rede');
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.length) {
                        container.innerHTML = '<p>Nenhuma peça cadastrada ainda.</p>';
                        return;
                    }

                    data.forEach(peca => {
                        const pecaHtml = `
                            <li>
                                <label>
                                    <input type="checkbox" value="${peca.id}" class="peca-checkbox"> ${peca.descricao}
                                </label>
                            </li>
                        `;
                        container.innerHTML += pecaHtml;
                    });

                    const checkboxes = document.querySelectorAll('.peca-checkbox');
                    checkboxes.forEach(checkbox => {
                        checkbox.addEventListener('change', updateSelectedPecas);
                    });
                })
                .catch(error => {
                    console.error('Erro ao buscar a lista de peças:', error);
                    container.innerHTML = '<p>Erro ao carregar a lista de peças.</p>';
                });
        }

        function getColaboradores(selectElement) {
            fetch('/colaborador') 
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro ao carregar a lista de colaboradores.');
                    }
                    return response.json();
                })
                .then(data => {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = "";
                    defaultOption.textContent = "Selecione o Colaborador";
                    defaultOption.disabled = true;
                    defaultOption.selected = true;
                    defaultOption.hidden = true;
                    selectElement.appendChild(defaultOption);

                    if (data.length === 0) {
                        selectElement.innerHTML += '<option value="">Nenhum colaborador disponível</option>';
                        return;
                    }

                    data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id; 
                        option.textContent = `${item.nome} | ${formatCPF(item.cpf)}`;
                        selectElement.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error(error);
                    selectElement.innerHTML = '<option value="">Erro ao carregar colaboradores</option>';
                });
        }

        function formatCPF(cpf) {
            return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        }
        
        // function getOs(){
        //     const container = document.querySelector('.listaOs');
        //     container.innerHTML = ''

        //     // Mudar endpoint
        //     fetch('/ordem-servico')
        //         .then(response => response.json())
        //         .then(data => {
        //             if (!data.length) {
        //                 container.innerHTML = '<p>Nenhuma OS cadastrada ainda.</p>';
        //             }

        //             data.forEach(ordem => {
        //                 const ordemHtml = `
        //                     <div class="osIndex" id="${ordem.id}">
        //                         <div>
        //                             <h2>${ordem.nomeCliente}</h2>
        //                             <span class="linhaDois"></span>
        //                         </div>
        //                         <div class="ordemServico">
        //                             <div>
        //                                 <p>Veículo</p>
        //                                 <h3>${ordem.veiculo}</h3>
        //                             </div>
        //                             <div>
        //                                 <p>Data</p>
        //                                 <h3>${ordem.data}</h3>
        //                             </div>
        //                             <div>
        //                                 <p>Valor Total</p>
        //                                 <h3>R$ ${ordem.valorTotal.toFixed(2).replace('.', ',')}</h3>
        //                             </div>
        //                             <div>
        //                                 <p>Status</p>
        //                                 <h3>${ordem.status}</h3>
        //                             </div>
        //                         </div>
        //                     </div>
        //                 `;
        //                 container.innerHTML += ordemHtml;
        //             });
        //         })
        //         .catch(error => {
        //             console.error('Erro ao buscar as ordens de serviço:', error);
        //             document.querySelector('.listaOs').innerHTML = '<p>Erro ao carregar as ordens de serviço.</p>';
        //         });
        // }

    </script>
</body>

</html>